<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>共用下單紀錄</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(160deg, #3d4140 0%, #2b2e2d 100%);
            --glass-bg: rgba(255, 255, 255, 0.96);
            --text-main: #333635;
            --text-sub: #8e9694;
            --primary: #8e9775;
            --font-family: 'Zen Maru Gothic', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 20px; min-height: 100vh; background: var(--bg-gradient); background-attachment: fixed; font-family: var(--font-family); color: var(--text-main); display: flex; justify-content: center; align-items: flex-start; }

        .app-container {
            background: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            width: 100%; max-width: 460px; border-radius: 50px; padding: 40px 20px;
            border: 2px solid #fff; box-shadow: 0 40px 80px rgba(0, 0, 0, 0.4);
            display: flex; flex-direction: column; margin-top: env(safe-area-inset-top);
        }

        h2 { text-align: center; font-size: 32px; font-weight: 900; margin: 0; letter-spacing: 0.15em; }
        .subtitle { text-align: center; font-size: 12px; color: var(--text-sub); margin-bottom: 25px; letter-spacing: 2px; }
        
        .user-info { font-size: 10px; color: var(--primary); text-align: center; margin-bottom: 15px; opacity: 0.7; word-break: break-all; }

        .section-box { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        input { border: 2px solid #f0f0f0; background: #fff; padding: 14px 18px; border-radius: 18px; font-family: var(--font-family); font-size: 15px; outline: none; }
        button#add-btn { background: var(--primary); color: #fff; border: none; padding: 14px; border-radius: 18px; font-family: var(--font-family); font-weight: 700; font-size: 16px; cursor: pointer; }

        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; background: #f4f4f0; padding: 5px; border-radius: 18px; }
        .tab { font-size: 12px; color: var(--text-sub); cursor: pointer; padding: 6px 14px; border-radius: 12px; font-weight: 700; }
        .tab.active { background: white; color: var(--text-main); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }

        .order-list { max-height: 400px; overflow-y: auto; }
        .order-item { background: #fff; margin-bottom: 10px; padding: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        
        .order-info { flex: 1; min-width: 0; cursor: pointer; margin-right: 8px; }
        .order-name { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .order-meta { font-size: 10px; color: var(--text-sub); }
        .order-author { font-size: 9px; color: var(--primary); font-style: italic; }

        .actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .status-badge { font-size: 10px; padding: 5px 10px; border-radius: 10px; border: 1.5px solid #eee; cursor: pointer; font-weight: 700; white-space: nowrap; }
        .status-delivered { background: var(--primary); color: #fff; border-color: var(--primary); }
        .delete-btn { color: #eee; cursor: pointer; background: none; border: none; font-size: 16px; }

        /* 彈窗 */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 999; }
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 35px; width: 85%; max-width: 320px; text-align: center; z-index: 1000; }
        .detail-card { text-align: left; background: #f9f9f7; padding: 15px; border-radius: 15px; margin-bottom: 20px; font-size: 14px; }
    </style>
</head>
<body>

<div id="modal-overlay" class="modal-overlay"></div>
<div id="detail-modal" class="modal-window">
    <h3 style="margin:0 0 15px 0; font-weight:900;">商品詳情</h3>
    <div class="detail-card" id="detail-content"></div>
    <button style="background:var(--primary); color:white; border:none; padding:10px 30px; border-radius:15px; font-family:var(--font-family); font-weight:700;" onclick="closeModal()">關閉</button>
</div>

<div class="app-container">
    <h2>下單紀錄</h2>
    <p class="subtitle">Cloud Sync Enabled</p>
    <div id="user-display" class="user-info">連線中...</div>
    
    <div class="section-box">
        <input type="text" id="itemName" placeholder="商品名稱">
        <input type="text" id="platform" placeholder="在哪裡買的？">
        <button id="add-btn">新增並同步</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-type="all">全部</div>
        <div class="tab" data-type="pending">待收貨</div>
        <div class="tab" data-type="done">已送達</div>
    </div>

    <div id="orderList" class="order-list"></div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let user = null;
    let orders = [];
    let currentFilter = 'all';

    // 1. 認證處理
    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    onAuthStateChanged(auth, (u) => {
        user = u;
        if (user) {
            document.getElementById('user-display').innerText = `我的 ID: ${user.uid}`;
            startSync();
        }
    });

    initAuth();

    // 2. 即時同步資料
    function startSync() {
        if (!user) return;
        // 使用 Rule 1 的指定路徑
        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
        
        // 監聽資料庫變化 (Rule 2: 簡單查詢)
        onSnapshot(ordersRef, (snapshot) => {
            orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // 在記憶體中排序 (最新在前面)
            orders.sort((a, b) => b.createdAt - a.createdAt);
            render();
        }, (error) => {
            console.error("同步失敗:", error);
        });
    }

    // 3. UI 互動
    const listEl = document.getElementById('orderList');
    const nameIn = document.getElementById('itemName');
    const platIn = document.getElementById('platform');

    document.getElementById('add-btn').onclick = async () => {
        if (!user || !nameIn.value.trim()) return;
        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
        await addDoc(ordersRef, {
            name: nameIn.value.trim(),
            platform: platIn.value.trim() || '未分類',
            isDelivered: false,
            createdAt: Date.now(),
            authorId: user.uid,
            authorName: '朋友'
        });
        nameIn.value = '';
        platIn.value = '';
    };

    window.toggleStatus = async (id, currentStatus) => {
        if (!user) return;
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
        await updateDoc(docRef, { isDelivered: !currentStatus });
    };

    window.deleteOrder = async (id) => {
        if (!user || !confirm('確定要刪除這筆共用紀錄嗎？')) return;
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
        await deleteDoc(docRef);
    };

    window.showDetails = (id) => {
        const o = orders.find(i => i.id === id);
        document.getElementById('detail-content').innerHTML = `
            <strong>商品：</strong> ${o.name}<br>
            <strong>平台：</strong> ${o.platform}<br>
            <strong>日期：</strong> ${new Date(o.createdAt).toLocaleString()}<br>
            <strong>狀態：</strong> ${o.isDelivered ? '已送達' : '待收貨'}<br>
            <strong>紀錄者：</strong> ${o.authorId}
        `;
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('detail-modal').style.display = 'block';
    };

    window.closeModal = () => {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('detail-modal').style.display = 'none';
    };

    document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.type;
            render();
        };
    });

    function render() {
        listEl.innerHTML = '';
        const filtered = orders.filter(o => {
            if (currentFilter === 'pending') return !o.isDelivered;
            if (currentFilter === 'done') return o.isDelivered;
            return true;
        });

        filtered.forEach(o => {
            const div = document.createElement('div');
            div.className = 'order-item';
            div.innerHTML = `
                <div class="order-info" onclick="showDetails('${o.id}')">
                    <span class="order-name">${o.name}</span>
                    <span class="order-meta">${o.platform}</span>
                    <span class="order-author">By: ${o.authorId.substring(0,6)}...</span>
                </div>
                <div class="actions">
                    <span class="status-badge ${o.isDelivered ? 'status-delivered' : ''}" onclick="toggleStatus('${o.id}', ${o.isDelivered})">
                        ${o.isDelivered ? '已送達' : '待收貨'}
                    </span>
                    <button class="delete-btn" onclick="deleteOrder('${o.id}')">✕</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }
</script>

</body>
</html>